name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Check Terraform formatting
        run: |
          echo "Checking Terraform formatting across all modules..."
          terraform fmt -check -recursive -diff
          echo "✅ All Terraform files are properly formatted"

  terraform-tests:
    name: Terraform Module Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        module:
          - s3-private-bucket
          - dynamodb-global-table
          - lambda-function
          - fargate-ecs-bluegreen
          - ses-email
          - sns-topic
          - networking-basics
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Initialize Terraform module
        run: |
          cd modules/${{ matrix.module }}
          terraform init

      - name: Run Terraform tests
        run: |
          cd modules/${{ matrix.module }}
          terraform test
          echo "✅ All tests passed for ${{ matrix.module }}"

  trivy-security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        id: trivy-scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          trivyignores: '.trivyignore'

      - name: Check Trivy scan results
        if: steps.trivy-scan.outcome == 'failure'
        run: |
          if [ -f trivy-results.sarif ]; then
            echo "Trivy scan exited with error. Checking SARIF file for actual issues..."
            # Parse SARIF file and show what issues were found
            python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('trivy-results.sarif', 'r') as f:
                  data = json.load(f)
              
              runs = data.get('runs', [])
              if not runs:
                  print("✅ No runs found in SARIF file.")
                  sys.exit(0)
              
              results = runs[0].get('results', [])
              if len(results) == 0:
                  print("✅ No security issues found in SARIF file. This appears to be a false positive.")
                  sys.exit(0)
              
              # Filter results to only CRITICAL/HIGH severity (error/warning level in SARIF)
              # SARIF levels: error=CRITICAL, warning=HIGH, note=LOW, none=INFO
              critical_high_results = [r for r in results if r.get('level') in ['error', 'warning']]
              
              if len(critical_high_results) == 0:
                  low_severity_count = len([r for r in results if r.get('level') == 'note'])
                  if low_severity_count > 0:
                      print(f"✅ Found {low_severity_count} LOW severity issue(s), but workflow only checks CRITICAL/HIGH.")
                      print("These LOW severity issues are being ignored as per workflow configuration.")
                  else:
                      print("✅ No CRITICAL or HIGH severity issues found.")
                  sys.exit(0)
              
              print(f"❌ Found {len(critical_high_results)} CRITICAL/HIGH severity issue(s):")
              for i, result in enumerate(critical_high_results[:10], 1):  # Show first 10 issues
                  rule_id = result.get('ruleId', 'unknown')
                  message = result.get('message', {}).get('text', 'no message')
                  level = result.get('level', 'unknown')
                  locations = result.get('locations', [])
                  location_info = ""
                  if locations:
                      loc = locations[0].get('physicalLocation', {})
                      artifact = loc.get('artifactLocation', {})
                      region = loc.get('region', {})
                      location_info = f" at {artifact.get('uri', 'unknown')}:{region.get('startLine', '?')}"
                  print(f"  {i}. [{level}] {rule_id}: {message}{location_info}")
              
              if len(critical_high_results) > 10:
                  print(f"  ... and {len(critical_high_results) - 10} more issue(s)")
              
              print("\nPlease review these issues and either:")
              print("1. Fix the security issues in the code")
              print("2. Add false positives to .trivyignore file")
              sys.exit(1)
          except Exception as e:
              print(f"Error parsing SARIF file: {e}")
              sys.exit(1)
          EOF
          else
            echo "❌ Trivy scan failed but no SARIF file was generated. This indicates a scan error."
            exit 1
          fi

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [terraform-fmt, terraform-tests, trivy-security-scan]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.terraform-fmt.result }}" == "success" ]; then
            echo "✅ Terraform Format Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Terraform Format Check: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.terraform-tests.result }}" == "success" ]; then
            echo "✅ Terraform Module Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Terraform Module Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.trivy-security-scan.result }}" == "success" ]; then
            echo "✅ Security Scan (Trivy): Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Security Scan (Trivy): Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Fail this job if any of the required jobs failed
          if [ "${{ needs.terraform-fmt.result }}" != "success" ] || \
             [ "${{ needs.terraform-tests.result }}" != "success" ] || \
             [ "${{ needs.trivy-security-scan.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ CI Pipeline Failed - Please review the failed jobs above" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All CI checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
